<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="blockly/blockly_uncompressed.js"></script>
    <script src="blockly/generators/javascript.js"></script>
    <script src="blockly/msg/js/es.js"></script>
    <script src="javascript.js"></script>
    <script src="bloques/ruedas.js"></script>
    <script src="bloques/pinza.js"></script>
    <script src="bloques/principal.js"></script>
    <script src="bloques/sensores.js"></script>
    <script src="blockly/blocks/logic.js"></script>
    <script src="blockly/blocks/loops.js"></script>
    <script src="blockly/blocks/math.js"></script>
    <script src="blockly/blocks/variables.js"></script>

    <style>
        html,
        body {
            background-color: #fff;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }
      
        .blocklySvg {
            height: 100%;
            width: 100%;
        }
    </style>
    <title>Lenguaje de alto nivel para robot arduino</title>
    <link rel="stylesheet" type="text/css" href="styles.css" />
</head>

<body>
    <iframe id='iframe' src='prueba1.txt' style="visibility:hidden;" onload='readMetodos()'> </iframe>
    <iframe id='iframe2' src='cabecera.txt' style="visibility:hidden;" onload='readCabecera()'> </iframe>
    <h1 id="header">Lenguaje de alto nivel para robot arduino</h1>
    <div id="blockly_editor">
        <div id="blocklyDiv" style="height: 650px; "></div>
        <xml id="toolbox" style="display: none">
            <category name="Movimientos robot">
                <block type="girar_hacia"></block>
                <block type="mover_hacia"></block>
                <block type="parar"></block>
                <block type="parar_tiempo"></block>
                <block type="ir_a"></block>
            </category>
            <category name="Movimientos pinza">
                <block type="subir_pinza"></block>
                <block type="bajar_pinza"></block>
                <block type="abrir_pinza"></block>
                <block type="cerrar_pinza"></block>
            </category>
            <category name="Sensores">
                <block type="detectar_linea"></block>
                <block type="distancia_obstaculo"></block>
            </category>
            <category name="Bucles">
                <block type="controls_repeat"></block>
                <block type="controls_whileUntil"></block>
            </category>
            <category name="Logico">
                <block type="controls_if"></block>
                <block type="logic_compare"></block>
            </category>
            <category name="Operaciones matematicas">
                <block type="math_number"></block>
            </category>
            <category name="Variables">
                <block type="variables_get"></block>
                <block type="variables_set"></block>
            </category>
        </xml>

        <xml id="startBlocks" style="display: none">
            <block type="bloque_principal"></block>
        </xml>

        <xml id="seguirLineaSimple" style="display: none">
            <block type="bloque_principal">
                <value name="variables"></value>
                <value name="cuerpo">
                    <block type="controls_if" inline="true">
                        <mutation else="0"></mutation>
                        <value name="IF0">
                            <block type="logic_compare">
                                <field name="OP">EQ</field>
                                <value name="A">
                                    <block type="detectar_linea">
                                        <field name="id_sensor">1</field>
                                    </block>
                                </value>
                                <value name="B">
                                    <block type="math_number">
                                        <field name="NUM">0</field>
                                    </block>
                                </value>
                            </block>
                        </value>
                        <statement name="DO0">
                            <block type="controls_if" inline="true">
                                <mutation else="0"></mutation>
                                <value name="IF0">
                                    <block type="logic_compare">
                                        <field name="OP">EQ</field>
                                        <value name="A">
                                            <block type="detectar_linea">
                                                <field name="id_sensor">2</field>
                                            </block>
                                        </value>
                                        <value name="B">
                                            <block type="math_number">
                                                <field name="NUM">0</field>
                                            </block>
                                        </value>
                                    </block>
                                </value>
                                <statement name="DO0">
                                    <block type="controls_if" inline="true">
                                        <mutation else="0"></mutation>
                                        <value name="IF0">
                                            <block type="logic_compare">
                                                <field name="OP">EQ</field>
                                                <value name="A">
                                                    <block type="detectar_linea">
                                                        <field name="id_sensor">3</field>
                                                    </block>
                                                </value>
                                                <value name="B">
                                                    <block type="math_number">
                                                        <field name="NUM">0</field>
                                                    </block>
                                                </value>
                                            </block>
                                        </value>
                                        <statement name="DO0">
                                            <block type="parar"></block>
                                        </statement>
                                    </block>
                                </statement>
                            </block>
                        </statement>
                        <next>
                            <block type="controls_if" inline="true">
                                <mutation else="0"></mutation>
                                <value name="IF0">
                                    <block type="detectar_linea">
                                        <field name="id_sensor">1</field>
                                    </block>
                                </value>
                                <statement name="DO0">
                                    <block type="controls_if" inline="true">
                                        <mutation else="0"></mutation>
                                        <value name="IF0">
                                            <block type="detectar_linea">
                                                <field name="id_sensor">2</field>
                                            </block>
                                        </value>
                                        <statement name="DO0">
                                            <block type="controls_if" inline="true">
                                                <mutation else="0"></mutation>
                                                <value name="IF0">
                                                    <block type="detectar_linea">
                                                        <field name="id_sensor">3</field>
                                                    </block>
                                                </value>
                                                <statement name="DO0">
                                                    <block type="mover_hacia">
                                                        <field name="direccion">delante</field>
                                                        <field name="metros">1</field>
                                                    </block>
                                                </statement>
                                            </block>
                                        </statement>
                                    </block>
                                </statement>
                                <next>
                                    <block type="controls_if" inline="true">
                                        <mutation else="0"></mutation>
                                        <value name="IF0">
                                            <block type="logic_compare">
                                                <field name="OP">EQ</field>
                                                <value name="A">
                                                    <block type="detectar_linea">
                                                        <field name="id_sensor">1</field>
                                                    </block>
                                                </value>
                                                <value name="B">
                                                    <block type="math_number">
                                                        <field name="NUM">0</field>
                                                    </block>
                                                </value>
                                            </block>
                                        </value>
                                        <statement name="DO0">
                                            <block type="girar_hacia">
                                                <field name="direccion">derecha</field>
                                                <field name="grados">10</field>
                                            </block>
                                        </statement>
                                        <next>
                                            <block type="controls_if" inline="true">
                                                <mutation else="0"></mutation>
                                                <value name="IF0">
                                                    <block type="detectar_linea">
                                                        <field name="id_sensor">3</field>
                                                    </block>
                                                </value>
                                                <statement name="DO0">
                                                    <block type="girar_hacia">
                                                        <field name="direccion">izquierda</field>
                                                        <field name="grados">10</field>
                                                    </block>
                                                </statement>
                                            </block>
                                        </next>
                                    </block>
                                </next>
                            </block>
                </value>
                </block>
        </xml>

        <xml id="seguirLineaObstaculos" style="display: none">
            <block type="bloque_principal">
                <value name="variables"></value>
                <value name="cuerpo">
                    <block type="controls_if" inline="true">
                        <mutation else="0"></mutation>
                        <value name="IF0">
                            <block type="logic_compare">
                                <field name="OP">EQ</field>
                                <value name="A">
                                    <block type="detectar_linea">
                                        <field name="id_sensor">1</field>
                                    </block>
                                </value>
                                <value name="B">
                                    <block type="math_number">
                                        <field name="NUM">0</field>
                                    </block>
                                </value>
                            </block>
                        </value>
                        <statement name="DO0">
                            <block type="controls_if" inline="true">
                                <mutation else="0"></mutation>
                                <value name="IF0">
                                    <block type="logic_compare">
                                        <field name="OP">EQ</field>
                                        <value name="A">
                                            <block type="detectar_linea">
                                                <field name="id_sensor">2</field>
                                            </block>
                                        </value>
                                        <value name="B">
                                            <block type="math_number">
                                                <field name="NUM">0</field>
                                            </block>
                                        </value>
                                    </block>
                                </value>
                                <statement name="DO0">
                                    <block type="controls_if" inline="true">
                                        <mutation else="0"></mutation>
                                        <value name="IF0">
                                            <block type="logic_compare">
                                                <field name="OP">EQ</field>
                                                <value name="A">
                                                    <block type="detectar_linea">
                                                        <field name="id_sensor">3</field>
                                                    </block>
                                                </value>
                                                <value name="B">
                                                    <block type="math_number">
                                                        <field name="NUM">0</field>
                                                    </block>
                                                </value>
                                            </block>
                                        </value>
                                        <statement name="DO0">
                                            <block type="parar"></block>
                                        </statement>
                                    </block>
                                </statement>
                            </block>
                        </statement>
                        <next>
                            <block type="controls_if" inline="true">
                                <mutation else="0"></mutation>
                                <value name="IF0">
                                    <block type="detectar_linea">
                                        <field name="id_sensor">1</field>
                                    </block>
                                </value>
                                <statement name="DO0">
                                    <block type="controls_if" inline="true">
                                        <mutation else="0"></mutation>
                                        <value name="IF0">
                                            <block type="detectar_linea">
                                                <field name="id_sensor">2</field>
                                            </block>
                                        </value>
                                        <statement name="DO0">
                                            <block type="controls_if" inline="true">
                                                <mutation else="0"></mutation>
                                                <value name="IF0">
                                                    <block type="detectar_linea">
                                                        <field name="id_sensor">3</field>
                                                    </block>
                                                </value>
                                                <statement name="DO0">
                                                    <block type="mover_hacia">
                                                        <field name="direccion">delante</field>
                                                        <field name="metros">1</field>
                                                    </block>
                                                </statement>
                                            </block>
                                        </statement>
                                    </block>
                                </statement>
                                <next>
                                    <block type="controls_if" inline="true">
                                        <mutation else="0"></mutation>
                                        <value name="IF0">
                                            <block type="logic_compare">
                                                <field name="OP">EQ</field>
                                                <value name="A">
                                                    <block type="detectar_linea">
                                                        <field name="id_sensor">1</field>
                                                    </block>
                                                </value>
                                                <value name="B">
                                                    <block type="math_number">
                                                        <field name="NUM">0</field>
                                                    </block>
                                                </value>
                                            </block>
                                        </value>
                                        <statement name="DO0">
                                            <block type="girar_hacia">
                                                <field name="direccion">derecha</field>
                                                <field name="grados">10</field>
                                            </block>
                                        </statement>
                                        <next>
                                            <block type="controls_if" inline="true">
                                                <mutation else="0"></mutation>
                                                <value name="IF0">
                                                    <block type="detectar_linea">
                                                        <field name="id_sensor">3</field>
                                                    </block>
                                                </value>
                                                <statement name="DO0">
                                                    <block type="girar_hacia">
                                                        <field name="direccion">izquierda</field>
                                                        <field name="grados">10</field>
                                                    </block>
                                                </statement>
                                                <next>
                                                    <block type="controls_if" inline="true">
                                                        <mutation else="0"></mutation>
                                                        <value name="IF0">
                                                            <block type="distancia_obstaculo">
                                                                <field name="centimetros">10</field>
                                                                <field name="id_sensor">5</field>
                                                            </block>
                                                        </value>
                                                        <statement name="DO0">
                                                            <block type="abrir_pinza">
                                                                <next>
                                                                    <block type="bajar_pinza">
                                                                        <field name="DIST">15</field>
                                                                        <next>

                                                                            <block type="cerrar_pinza">
                                                                                <next>
                                                                                    <block type="subir_pinza">
                                                                                        <field name="DIST">15</field>
                                                                                        <next>
                                                                                            <block type="girar_hacia">
                                                                                                <field name="direccion">derecha</field>
                                                                                                <field name="grados">90</field>
                                                                                                <next>
                                                                                                    <block type="bajar_pinza">
                                                                                                        <field name="DIST">15</field>
                                                                                                        <next>
                                                                                                            <block type="abrir_pinza">
                                                                                                                <next>
                                                                                                                    <block type="subir_pinza">
                                                                                                                        <field name="DIST">15</field>
                                                                                                                        <next>
                                                                                                                            <block type="girar_hacia">
                                                                                                                                <field name="direccion">izquierda</field>
                                                                                                                                <field name="grados">90</field>
                                                                                                                            </block>
                                                                                                                        </next>
                                                                                                                    </block>
                                                                                                                </next>
                                                                                                            </block>
                                                                                                        </next>
                                                                                                    </block>
                                                                                                </next>
                                                                                            </block>
                                                                                        </next>

                                                                                    </block>

                                                                                </next>
                                                                            </block>
                                                                        </next>
                                                                    </block>
                                                                </next>
                                                            </block>
                                                        </statement>
                                                    </block>
                                                </next>
                                            </block>
                                        </next>
                                    </block>
                                </next>
                            </block>
                </value>
                </block>
        </xml>



    </div>

    <div id="codigo_generado">
        <button id="button_run" onclick="run_code()">
            Generar codigo arduino
        </button>
        <button id="button_limpiar" onclick="limpiarWorkSpace()">Limpiar Workspace</button>
        <button id="button_seguir" onclick="cargarSeguirLinea()"> Seguir linea program</button>
        <button id="button_seguir_obstaculos" onclick="cargarSeguirLineaObstaculos()"> Seguir linea con obstaculos</button>
        <button id="button_laberinto_cajas" onclick="cargarLaberintoCajas()">Laberinto de cajas</button>

        <textarea readonly id="codigo"></textarea>
        <div id="miDiv"></div>
    </div>
    <footer>
        <p>Trabajo realizado por: Jose Manuel Garcia Fernandez</p>
        <p>Universidad de Oviedo</p>
    </footer>
    <script>
        var workspace = Blockly.inject('blocklyDiv',
        {media: '../../media/',
         toolbox: document.getElementById('toolbox')});
          Blockly.Xml.domToWorkspace(workspace,
        document.getElementById('startBlocks'));
         var text='';
         var cabecera='';
               
        function run_code() {
			code = Blockly.JavaScript.workspaceToCode(workspace);
            var div = document.getElementById("codigo");          
            div.textContent = cabecera + code.replace(/var /g,"int ") + text ;                
		}
        
        function readMetodos(){
            text = document.getElementById('iframe').contentDocument.body.firstChild.textContent;
        }
                
        function readCabecera() {
            cabecera = document.getElementById('iframe2').contentDocument.body.firstChild.textContent;
       }

        function cargarSeguirLinea() {    
            Blockly.mainWorkspace.clear();
            Blockly.Xml.domToWorkspace(workspace,
            document.getElementById('seguirLineaSimple'));        
        }
        
        function limpiarWorkSpace(){
            Blockly.mainWorkspace.clear();
            Blockly.Xml.domToWorkspace(workspace,
            document.getElementById('startBlocks')); 
        }
        
        function cargarSeguirLineaObstaculos(){
           Blockly.mainWorkspace.clear();
           Blockly.Xml.domToWorkspace(workspace,
           document.getElementById('seguirLineaObstaculos')); 
        }
        
        function cargarLaberintoCajas(){
            Blockly.mainWorkspace.clear();
           Blockly.Xml.domToWorkspace(workspace,
           document.getElementById('laberintoCajas'));
        }
    </script>

</body>

</html>