<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="blockly/blockly_uncompressed.js"></script>
    <script src="blockly/generators/javascript.js"></script>
    <script src="blockly/msg/js/es.js"></script>
    <script src="javascript.js"></script>
    <script src="bloques/ruedas.js"></script>
    <script src="bloques/pinza.js"></script>
    <script src="bloques/principal.js"></script>
    <script src="bloques/sensores.js"></script>
    <script src="blockly/blocks/logic.js"></script>
    <script src="blockly/blocks/loops.js"></script>
    <script src="blockly/blocks/math.js"></script>
    <script src="blockly/blocks/variables.js"></script>

    <style>
        html,
        body {
            background-color: #fff;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }
        
        .blocklySvg {
            height: 100%;
            width: 100%;
        }
    </style>
    <title>Lenguaje de alto nivel para robot arduino</title>
    <link rel="stylesheet" type="text/css" href="styles.css" />
</head>

<body>
    <h1 id="header">Lenguaje de alto nivel para robot arduino</h1>
    <div id="blockly_editor">
        <div id="blocklyDiv" style="height: 650px; "></div>
        <xml id="toolbox" style="display: none">
            <category name="Movimientos robot">
                <block type="girar_hacia"></block>
                <block type="mover_hacia"></block>
                <block type="parar"></block>
                <block type="parar_tiempo"></block>
                <block type="ir_a"></block>
            </category>
            <category name="Movimientos pinza">
                <block type="subir_pinza"></block>
                <block type="bajar_pinza"></block>
                <block type="abrir_pinza"></block>
                <block type="cerrar_pinza"></block>
            </category>
            <category name="Sensores">
                <block type="detectar_linea"></block>
                <block type="distancia_obstaculo"></block>
            </category>
            <category name="Bucles">
                <block type="controls_repeat"></block>
                <block type="controls_whileUntil"></block>
            </category>
            <category name="Logico">
                <block type="controls_if"></block>
                <block type="logic_compare"></block>
            </category>
            <category name="Operaciones matematicas">
                <block type="math_number"></block>
            </category>
            <category name="Variables">
                <block type="variables_get"></block>
                <block type="variables_set"></block>
            </category>
        </xml>

        <xml id="startBlocks" style="display: none">
            <block type="bloque_principal"></block>
        </xml>
        
<xml id="seguirLineaSimple" style="display: none">
            <block type="bloque_principal">
                <value name="variables">
                        <block type="variables_set">
                                <field name="VAR">ha_terminado</field>
                                <value name="VALUE">
                                    <block type="math_number">
                                        <field name="NUM">1</field>
                                    </block>
                                </value>                   
                        </block>
                </value>
                <value name="cuerpo">
                    <block type="controls_whileUntil">
                        <field name="MODE">WHILE</field>
                         <value name="BOOL">
                            <block type="logic_compare" inline="true">
                                <field name="OP">EQ</field>
                                <value name="A">
                                    <block type="variables_get" >
                                        <field name="VAR">ha_terminado</field>
                                    </block>
                                </value>
                                <value name="B">
                                    <block type="math_number">
                                    <field name="NUM">1</field>
                                    </block>
                                </value>
                            </block>
                        </value>
                        <value name="DO">                             
                             <block type="controls_if" inline="true">
                                <mutation else="0"></mutation>
                                <value name="IF0">
                                    <block type="detectar_linea" >
                                        <field name="id_sensor">1</field>
                                    </block>
                                </value>
                                <statement name="DO0">
                                      <block type="controls_if" inline="true">
                                            <mutation else="0"></mutation>
                                            <value name="IF0">
                                                <block type="detectar_linea" >
                                                    <field name="id_sensor">2</field>
                                                </block>
                                            </value>
                                            <statement name="DO0">
                                                <block type="controls_if" inline="true">
                                                    <mutation else="0"></mutation>
                                                    <value name="IF0">
                                                        <block type="detectar_linea" >
                                                            <field name="id_sensor">3</field>
                                                        </block>
                                                    </value>
                                                    <statement name="DO0">
                                                             <block type="controls_if" inline="true">
                                                                    <mutation else="0"></mutation>
                                                                    <value name="IF0">
                                                                        <block type="detectar_linea" >
                                                                            <field name="id_sensor">4</field>
                                                                        </block>
                                                                    </value>
                                                                    <statement name="DO0">
                                                                        <block type="parar" ></block>
                                                                        <block type="variables_set">
                                                                               <field name="VAR">ha_terminado</field>
                                                                                <value name="VALUE">
                                                                                    <block type="math_number">
                                                                                        <field name="NUM">1</field>
                                                                                    </block>
                                                                                </value>   
                                                                        </block>
                                                                    </statement>
                                                               </block>
                                                    </statement>
                                                </block> 
                                            </statement>
                                        </block>
                                </statement>         
                             </block>
                        </value>
                    </block>
                </value>            
            </block>
</xml>

    </div>

    <div id="codigo_generado">
        <button id="button_run" onclick="run_code()">
            Generar codigo arduino
        </button>
        <button id="button_seguir" onclick="cargarSeguirLinea()"> Seguir linea program</button>

        <textarea readonly id="codigo"></textarea>
        <div id="miDiv"></div>
    </div>
    <footer>
        <p>Trabajo realizado por: Jose Manuel Garcia Fernandez</p>
        <p>Universidad de Oviedo</p>
    </footer>
    <script>
        var workspace = Blockly.inject('blocklyDiv',
        {media: '../../media/',
         toolbox: document.getElementById('toolbox')});
          Blockly.Xml.domToWorkspace(workspace,
        document.getElementById('startBlocks'));
         var text='';
               
        function run_code() {
			code = Blockly.JavaScript.workspaceToCode(workspace);
             var div = document.getElementById("codigo");
             
             var iframe = document.createElement('iframe');
            iframe.id = 'iframe';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            iframe.src = 'metodos_predet.txt';
            setTimeout(function(){
                var text = document.getElementById('iframe').contentDocument.body.firstChild.innerHTML;
                div.textContent = code.replace(/var /g,"int ") +text ;
            }, 1000);                   
		}
        
        function cargarSeguirLinea() {
            
            Blockly.Xml.domToWorkspace(workspace,
            document.getElementById('seguirLineaSimple'));        
        }
    </script>

</body>

</html>